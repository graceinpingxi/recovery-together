<!DOCTYPE html>
<html lang="tw">
<script>
// 1. 確保匯入了 App Check 模組
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js";
import { getFirestore, ... } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
    // ... 你的原有配置
};

const app = initializeApp(firebaseConfig);

// 2. 啟動 App Check
// 如果你申請的是 reCAPTCHA v3，請使用 ReCaptchaV3Provider
// 如果是 Enterprise 版本，請使用 ReCaptchaEnterpriseProvider
const appCheck = initializeAppCheck(app, {
  provider: new ReCaptchaV3Provider('6LfrUXUsAAAAAIyuyzyIFKT5tx_eDiD6YCyyKPyA'),
  isTokenAutoRefreshEnabled: true 
});

const db = getFirestore(app);
// ... 後續 Firestore 代碼
});

const db = getFirestore(app);
// ... 後續的 Firestore 代碼
  // 1. 匯入 Firebase 必要的功能
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
  // 2. 這裡貼上你剛剛獲取的 Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCBEVJ9xmurbqhpu9c-er1F6EG3cI8NttI",
    authDomain: "recovery-together.firebaseapp.com",
    projectId: "recovery-together",
    storageBucket: "recovery-together.firebasestorage.app",
    messagingSenderId: "711126415467",
    appId: "711126415467:web:228c2df6b32eb196f4592e"
  };

  // 3. 初始化 Firebase 與 Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const messagesCol = collection(db, "messages");

  // --- A. 發佈訊息到雲端 ---
  window.postMessage = async function() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();

    if (text === "") {
        alert("請輸入內容！");
        return;
    }

    try {
        await addDoc(messagesCol, {
            text: text,
            createdAt: serverTimestamp() // 紀錄伺服器時間
        });
        input.value = ""; // 清空輸入框
    } catch (e) {
        console.error("發布失敗: ", e);
    }
  };

  // --- B. 從雲端即時讀取訊息 ---
  const q = query(messagesCol, orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    const board = document.getElementById('messageBoard');
    board.innerHTML = ""; // 先清空，再重新渲染
    
    snapshot.forEach((doc) => {
        const data = doc.data();
        const card = document.createElement('div');
        card.className = 'message-card';
        card.innerText = data.text;
        board.appendChild(card);
    });

  // 3. 初始化 Firebase 與 Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const messagesCol = collection(db, "messages");

  // --- A. 發佈訊息到雲端 ---
  window.postMessage = async function() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();

    if (text === "") {
        alert("請輸入內容！");
        return;
    }

    try {
        await addDoc(messagesCol, {
            text: text,
            createdAt: serverTimestamp() // 紀錄伺服器時間
        });
        input.value = ""; // 清空輸入框
    } catch (e) {
        console.error("發布失敗: ", e);
    }
  };

 // --- B. 從雲端即時讀取訊息並顯示時間 ---
  const q = query(messagesCol, orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    const board = document.getElementById('messageBoard');
    board.innerHTML = ""; 
    
    snapshot.forEach((doc) => {
        const data = doc.data();
        
        // 建立卡片容器
        const card = document.createElement('div');
        card.className = 'message-card';

        // 處理時間格式 (處理 Firebase 剛寫入時可能產生的短暫 null 值)
        let timeString = "傳送中...";
        if (data.createdAt) {
            const date = data.createdAt.toDate(); // 將 Firebase 時間轉為 JS Date 物件
            timeString = date.toLocaleString('zh-TW', { 
                hour12: true, 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // 組合內容：文字 + 時間
        card.innerHTML = `
            <div class="message-text">${data.text}</div>
            <div class="message-time">${timeString}</div>
        `;
        
        board.appendChild(card);
    });
        
    </script>
</body>
    <nav>
        <h1>Recovery Together 一起復元</h1>
    </nav>

    <main id="app">
        <section class="input-area">
            <h3>分享你的復元力量</h3>
            <input type="text" id="nicknameInput" placeholder="你的暱稱 (例如：小明)..." style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
              
            <textarea id="messageInput" placeholder="寫下你想對大家說的話..."></textarea>
            <button onclick="postMessage()">發佈訊息</button>
        </section>

            <div id="messageBoard">
                </div>
        </section>
    </main>
</body>
</html>
