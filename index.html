<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一起復元 | Recovery Together</title>
    <style>
        /* 樣式表：保持介面整潔溫暖 */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; color: #333; margin: 0; }
        nav { background-color: #4a90e2; color: white; padding: 1rem; text-align: center; }
        main { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .input-area { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        textarea { width: 100%; height: 100px; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; padding: 10px; box-sizing: border-box; resize: vertical; }
        button { background-color: #4a90e2; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 1rem; }
        button:hover { background-color: #357abd; }
        .message-card { background: white; border-left: 5px solid #4a90e2; margin-top: 1rem; padding: 1rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .message-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .message-nickname { font-weight: bold; color: #4a90e2; }
        .message-time { color: #888; }
        .message-text { line-height: 1.6; white-space: pre-wrap; }
    </style>
</head>
<body>
    <nav>
        <h1>Recovery Together 一起復元</h1>
    </nav>

    <main id="app">
        <section class="input-area">
            <h3>分享你的復元力量</h3>
            <input type="text" id="nicknameInput" placeholder="你的暱稱 (例如：小明)..." style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            <textarea id="messageInput" placeholder="寫下你想對大家說的話..."></textarea>
            <button id="sendBtn">發佈訊息</button>
        </section>

        <section class="board">
            <h3>復元佈告欄</h3>
            <div id="messageBoard">
                </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // 你的 Firebase 配置 (已根據你提供的資料填入)
        const firebaseConfig = {
            apiKey: "AIzaSyCBEVJ9xmurbqhpu9c-er1F6EG3cI8NttI",
            authDomain: "recovery-together.firebaseapp.com",
            projectId: "recovery-together",
            storageBucket: "recovery-together.firebasestorage.app",
            messagingSenderId: "711126415467",
            appId: "711126415467:web:228c2df6b32eb196f4592e"
        };

        // 1. 初始化 App
        const app = initializeApp(firebaseConfig);

        // 2. 初始化 App Check (使用你申請的 Site Key)
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LfrUXUsAAAAAIyuyzyIFKT5tx_eDiD6YCyyKPyA'),
            isTokenAutoRefreshEnabled: true
        });

        // 3. 初始化資料庫
        const db = getFirestore(app);
        const messagesCol = collection(db, "messages");

        // --- A. 發佈訊息邏輯 ---
        document.getElementById('sendBtn').addEventListener('click', async () => {
            const nicknameInput = document.getElementById('nicknameInput');
            const messageInput = document.getElementById('messageInput');
            
            const nickname = nicknameInput.value.trim() || "匿名夥伴";
            const text = messageInput.value.trim();

            if (text === "") {
                alert("請輸入內容！");
                return;
            }

            try {
                await addDoc(messagesCol, {
                    nickname: nickname,
                    text: text,
                    createdAt: serverTimestamp()
                });
                messageInput.value = ""; // 只清空訊息，保留暱稱
                console.log("發布成功！");
            } catch (e) {
                console.error("發布失敗: ", e);
                alert("發布失敗，請確認 Firebase 規則與 App Check 設定。");
            }
        });

        // --- B. 即時顯示訊息與時間 ---
        const q = query(messagesCol, orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const board = document.getElementById('messageBoard');
            board.innerHTML = ""; 
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                const card = document.createElement('div');
                card.className = 'message-card';

                let timeString = "傳送中...";
                if (data.createdAt) {
                    const date = data.createdAt.toDate();
                    timeString = date.toLocaleString('zh-TW', { 
                        month: 'short', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });
                }

                card.innerHTML = `
                    <div class="message-header">
                        <span class="message-nickname">${data.nickname || "匿名夥伴"}</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-text">${data.text}</div>
                `;
                board.appendChild(card);
            });
        });
    </script>
</body>
</html>
